<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blais Beats - Pro Admin Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: rgba(20, 20, 30, 0.95);
            border-right: 2px solid rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            text-align: center;
        }

        .sidebar-header h1 {
            color: #00FFFF;
            font-size: 24px;
            font-weight: bold;
        }

        .sidebar-header p {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }

        .nav-section {
            margin: 20px 0;
        }

        .nav-section h3 {
            color: #00FFFF;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 20px 10px 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(0, 255, 255, 0.1);
            color: #00FFFF;
            border-left-color: #00FFFF;
        }

        .nav-item.active {
            background: rgba(0, 255, 255, 0.2);
            color: #00FFFF;
            border-left-color: #00FFFF;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            overflow-y: auto;
        }

        .page-header {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .page-header h1 {
            color: #00FFFF;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .page-header p {
            color: #888;
            font-size: 16px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            border-color: #00FFFF;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #00FFFF;
            font-size: 18px;
        }

        .card-title {
            color: #00FFFF;
            font-size: 18px;
            font-weight: 600;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .card-change {
            font-size: 14px;
            color: #4CAF50;
        }

        .card-change.negative {
            color: #f44336;
        }

        /* Form Styles */
        .form-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            color: #00FFFF;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00FFFF, #0099CC);
            color: #000000;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #00CCCC, #007799);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: #ffffff;
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #ff0000, #990000);
        }

        /* Tables */
        .data-table {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 255, 255, 0.1);
            color: #00FFFF;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        /* Upload Areas */
        .upload-area {
            border: 2px dashed rgba(0, 255, 255, 0.4);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #00FFFF;
            background: rgba(0, 255, 255, 0.05);
        }

        .upload-area.dragover {
            border-color: #00FFFF;
            background: rgba(0, 255, 255, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #00FFFF;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #888;
        }

        /* File Grid */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .file-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-item:hover {
            transform: translateY(-3px);
            border-color: #00FFFF;
        }

        .file-icon {
            font-size: 32px;
            color: #00FFFF;
            margin-bottom: 10px;
        }

        .file-name {
            font-size: 14px;
            color: #ffffff;
            word-break: break-word;
        }

        .file-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* Progress Bar */
        .progress-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #00FFFF, #00FF00);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Status Messages */
        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .status-info {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00FFFF;
            color: #00FFFF;
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-item:hover {
            border-color: #00FFFF;
            transform: scale(1.05);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-item:hover .delete-btn {
            opacity: 1;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #00FFFF;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>BLAIS BEATS</h1>
                <p>Pro Admin Dashboard</p>
            </div>

            <div class="nav-section">
                <h3>Overview</h3>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i>üìä</i>
                    Dashboard
                </div>
            </div>

            <div class="nav-section">
                <h3>Content</h3>
                <div class="nav-item" onclick="showSection('tracks')">
                    <i>üéµ</i>
                    Tracks & Beats
                </div>
                <div class="nav-item" onclick="showSection('collections')">
                    <i>üìö</i>
                    Collections
                </div>
                <div class="nav-item" onclick="showSection('soundkits')">
                    <i>üéõÔ∏è</i>
                    Sound Kits
                </div>
                <div class="nav-item" onclick="showSection('photos')">
                    <i>üñºÔ∏è</i>
                    Photos & Artwork
                </div>
                <div class="nav-item" onclick="showSection('filestorage')">
                    <i>üíæ</i>
                    File Storage
                </div>
            </div>

            <div class="nav-section">
                <h3>Sales & Analytics</h3>
                <div class="nav-item" onclick="showSection('sales')">
                    <i>üí∞</i>
                    Sales Reports
                </div>
                <div class="nav-item" onclick="showSection('analytics')">
                    <i>üìà</i>
                    Analytics
                </div>
                <div class="nav-item" onclick="showSection('customers')">
                    <i>üë•</i>
                    Customers
                </div>
                <div class="nav-item" onclick="showSection('orders')">
                    <i>üìã</i>
                    Orders
                </div>
            </div>

            <div class="nav-section">
                <h3>Tools & Settings</h3>
                <div class="nav-item" onclick="showSection('automation')">
                    <i>ü§ñ</i>
                    Automation
                </div>
                <div class="nav-item" onclick="showSection('bulk-upload')">
                    <i>üì§</i>
                    Bulk Upload
                </div>
                <div class="nav-item" onclick="showSection('dropbox-import')">
                    <i>‚òÅÔ∏è</i>
                    Dropbox Import
                </div>
                <div class="nav-item" onclick="showSection('settings')">
                    <i>‚öôÔ∏è</i>
                    Settings
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="page-header">
                    <h1>Dashboard Overview</h1>
                    <p>Welcome back! Here's what's happening with your beat store.</p>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üí∞</div>
                            <div class="card-title">Revenue (30 days)</div>
                        </div>
                        <div class="card-value" id="revenue-value">$0</div>
                        <div class="card-change">+0% from last month</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üéµ</div>
                            <div class="card-title">Total Beats</div>
                        </div>
                        <div class="card-value" id="beats-count">0</div>
                        <div class="card-change">Ready for sale</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üìä</div>
                            <div class="card-title">Sales This Month</div>
                        </div>
                        <div class="card-value" id="sales-count">0</div>
                        <div class="card-change">+0% from last month</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Total Customers</div>
                        </div>
                        <div class="card-value" id="customers-count">0</div>
                        <div class="card-change">Active users</div>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Quick Actions</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn btn-primary" onclick="showSection('tracks')">üéµ Add New Beat</button>
                        <button class="btn btn-primary" onclick="showSection('bulk-upload')">üì§ Bulk Upload</button>
                        <button class="btn btn-primary" onclick="showSection('collections')">üìö Create Collection</button>
                        <button class="btn btn-secondary" onclick="showSection('analytics')">üìà View Analytics</button>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Recent Activity</h2>
                    <div id="recent-activity">
                        <p style="color: #888; text-align: center; padding: 20px;">No recent activity to display.</p>
                    </div>
                </div>
            </div>

            <!-- Tracks & Beats Section -->
            <div id="tracks" class="content-section">
                <div class="page-header">
                    <h1>Tracks & Beats Management</h1>
                    <p>Upload, edit, and manage your beats catalog</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Add New Beat</h2>

                    <!-- File Upload Area -->
                    <div class="upload-area" onclick="document.getElementById('beat-files').click()">
                        <div class="upload-icon">üéµ</div>
                        <div class="upload-text">Upload Beat Files</div>
                        <div class="upload-subtext">Drag & drop or click to select files (WAV, MP3, ZIP)</div>
                    </div>
                    <input type="file" id="beat-files" multiple accept="audio/*,.zip" style="display: none;">

                    <!-- Beat Information Form -->
                    <form id="beat-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="beat-title">Beat Title</label>
                                <input type="text" id="beat-title" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="beat-bpm">BPM</label>
                                <input type="number" id="beat-bpm" class="form-control" min="60" max="200">
                            </div>
                            <div class="form-group">
                                <label for="beat-key">Key</label>
                                <select id="beat-key" class="form-control">
                                    <option value="">Select Key</option>
                                    <option value="C">C</option>
                                    <option value="C#">C#</option>
                                    <option value="D">D</option>
                                    <option value="D#">D#</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="F#">F#</option>
                                    <option value="G">G</option>
                                    <option value="G#">G#</option>
                                    <option value="A">A</option>
                                    <option value="A#">A#</option>
                                    <option value="B">B</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="beat-scale">Scale</label>
                                <select id="beat-scale" class="form-control">
                                    <option value="">Select Scale</option>
                                    <option value="major">Major</option>
                                    <option value="minor">Minor</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="beat-tags">Tags (comma separated)</label>
                                <input type="text" id="beat-tags" class="form-control" placeholder="trap, dark, piano, emotional">
                            </div>
                            <div class="form-group full-width">
                                <label for="beat-description">Description</label>
                                <textarea id="beat-description" class="form-control" rows="3"></textarea>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="clearBeatForm()">Clear Form</button>
                            <button type="submit" class="btn btn-primary">Save Beat</button>
                        </div>
                    </form>
                </div>

                <!-- Beats List -->
                <div class="form-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #00FFFF; margin: 0;">Your Beats</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="beats-search" placeholder="Search beats..." class="form-control" style="width: 250px;">
                            <select id="beats-filter" class="form-control" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="featured">Featured</option>
                            </select>
                            <button class="btn btn-secondary" onclick="toggleBulkBeats()">Bulk Actions</button>
                        </div>
                    </div>

                    <div id="bulk-beats-actions" style="display: none; margin-bottom: 15px; padding: 15px; background: rgba(0,255,255,0.1); border-radius: 8px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button id="select-all-beats" class="btn btn-secondary" onclick="selectAllBeats()">Select All</button>
                            <button id="publish-selected" class="btn btn-primary" onclick="bulkPublishBeats()" disabled>Publish Selected (0)</button>
                            <button id="feature-selected" class="btn btn-primary" onclick="bulkFeatureBeats()" disabled>Feature Selected (0)</button>
                            <button id="delete-selected-beats" class="btn btn-danger" onclick="bulkDeleteBeats()" disabled>Delete Selected (0)</button>
                        </div>
                    </div>

                    <div id="beats-list">
                        <p style="color: #888; text-align: center; padding: 20px;">Loading beats...</p>
                    </div>
                </div>
            </div>

            <!-- Collections Section -->
            <div id="collections" class="content-section">
                <div class="page-header">
                    <h1>Collections Management</h1>
                    <p>Organize your beats into collections and albums</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Create New Collection</h2>

                    <form id="collection-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="collection-name">Collection Name</label>
                                <input type="text" id="collection-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="collection-type">Collection Type</label>
                                <select id="collection-type" class="form-control" required>
                                    <option value="">Select Type</option>
                                    <option value="album">Album</option>
                                    <option value="playlist">Playlist</option>
                                    <option value="genre">Genre Collection</option>
                                    <option value="mood">Mood Collection</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="collection-description">Description</label>
                                <textarea id="collection-description" class="form-control" rows="3"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Create Collection</button>
                    </form>
                </div>

                <!-- Beat Selection for Collections -->
                <div class="form-container" id="collection-beat-selection" style="display: none;">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Add Beats to Collection</h2>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="beat-search-collection" placeholder="Search beats..." class="form-control" style="width: 300px; display: inline-block; margin-right: 10px;">
                        <button class="btn btn-secondary" onclick="hideCollectionBeatSelection()">Cancel</button>
                    </div>
                    <div id="collection-beat-list"></div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Your Collections</h2>
                    <div id="collections-list">
                        <p style="color: #888; text-align: center; padding: 20px;">Loading collections...</p>
                    </div>
                </div>
            </div>

            <!-- Sound Kits Section -->
            <div id="soundkits" class="content-section">
                <div class="page-header">
                    <h1>Sound Kits Management</h1>
                    <p>Create and manage sample packs and sound kits</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Create Sound Kit</h2>

                    <div class="upload-area" onclick="document.getElementById('kit-files').click()">
                        <div class="upload-icon">üéõÔ∏è</div>
                        <div class="upload-text">Upload Kit Files</div>
                        <div class="upload-subtext">Select multiple audio files for your kit</div>
                    </div>
                    <input type="file" id="kit-files" multiple accept="audio/*" style="display: none;">

                    <div id="kit-files-preview" style="display: none; margin: 20px 0;">
                        <h3 style="color: #00FFFF; margin-bottom: 10px;">Selected Files</h3>
                        <div id="kit-files-list"></div>
                    </div>

                    <form id="soundkit-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="kit-name">Kit Name</label>
                                <input type="text" id="kit-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="kit-genre">Genre</label>
                                <select id="kit-genre" class="form-control">
                                    <option value="">Select Genre</option>
                                    <option value="trap">Trap</option>
                                    <option value="drill">Drill</option>
                                    <option value="lofi">Lo-Fi</option>
                                    <option value="boom-bap">Boom Bap</option>
                                    <option value="rnb">R&B</option>
                                    <option value="pop">Pop</option>
                                    <option value="rock">Rock</option>
                                    <option value="electronic">Electronic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kit-price">Price ($)</label>
                                <input type="number" id="kit-price" class="form-control" step="0.01" value="19.99">
                            </div>
                            <div class="form-group">
                                <label for="kit-bpm">BPM Range</label>
                                <input type="text" id="kit-bpm" class="form-control" placeholder="e.g., 120-140">
                            </div>
                            <div class="form-group full-width">
                                <label for="kit-description">Description</label>
                                <textarea id="kit-description" class="form-control" rows="3"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Create Sound Kit</button>
                    </form>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Your Sound Kits</h2>
                    <div id="soundkits-list">
                        <p style="color: #888; text-align: center; padding: 20px;">Loading sound kits...</p>
                    </div>
                </div>
            </div>

            <!-- Photos & Artwork Section -->
            <div id="photos" class="content-section">
                <div class="page-header">
                    <h1>Photos & Artwork</h1>
                    <p>Manage your beat covers, artwork, and promotional images</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Upload Images</h2>

                    <div class="upload-area" id="image-upload-area">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text">Upload Images</div>
                        <div class="upload-subtext">Drag & drop or click to select images (JPG, PNG, WebP)</div>
                    </div>
                    <input type="file" id="image-files" multiple accept="image/*" style="display: none;">

                    <div style="margin: 20px 0;">
                        <button id="bulk-delete-btn" class="btn btn-danger" onclick="toggleBulkDeleteMode()">Delete Images</button>
                        <div id="bulk-delete-actions" style="display: none; margin-top: 10px;">
                            <button id="select-all-btn" class="btn btn-secondary" onclick="selectAllImages()">Select All</button>
                            <button id="delete-selected-btn" class="btn btn-danger" onclick="deleteSelectedImages()" disabled>Delete Selected (0)</button>
                        </div>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Image Library</h2>
                    <div id="image-grid" class="image-grid">
                        <p style="color: #888; text-align: center; padding: 20px; grid-column: 1 / -1;">Loading images...</p>
                    </div>
                </div>
            </div>

            <!-- File Storage Section -->
            <div id="filestorage" class="content-section">
                <div class="page-header">
                    <h1>File Storage</h1>
                    <p>Organize and manage all your uploaded files</p>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-number" id="storage-used">0 MB</div>
                        <div class="stat-label">Storage Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-files">0</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="audio-files">0</div>
                        <div class="stat-label">Audio Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="image-files">0</div>
                        <div class="stat-label">Image Files</div>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">File Browser</h2>
                    <div id="file-browser">
                        <p style="color: #888; text-align: center; padding: 20px;">Loading file browser...</p>
                    </div>
                </div>
            </div>

            <!-- Sales Reports Section -->
            <div id="sales" class="content-section">
                <div class="page-header">
                    <h1>Sales Reports</h1>
                    <p>Track your sales performance and revenue</p>
                </div>

                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-number" id="total-revenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthly-sales">0</div>
                        <div class="stat-label">This Month Sales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="best-seller">-</div>
                        <div class="stat-label">Best Selling Beat</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-order">$0</div>
                        <div class="stat-label">Average Order</div>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Recent Sales</h2>
                    <div id="sales-table">
                        <p style="color: #888; text-align: center; padding: 20px;">No sales data available.</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="page-header">
                    <h1>Analytics Dashboard</h1>
                    <p>Deep insights into your store performance</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Traffic Analytics</h2>
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #888;">Analytics dashboard coming soon...</p>
                        <p style="color: #666; font-size: 14px;">Integration with Google Analytics and custom tracking</p>
                    </div>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers" class="content-section">
                <div class="page-header">
                    <h1>Customer Management</h1>
                    <p>View and manage your customer database</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Customer List</h2>
                    <div id="customers-table">
                        <p style="color: #888; text-align: center; padding: 20px;">No customer data available.</p>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="content-section">
                <div class="page-header">
                    <h1>Order Management</h1>
                    <p>Track and manage all customer orders</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Recent Orders</h2>
                    <div id="orders-table">
                        <p style="color: #888; text-align: center; padding: 20px;">No orders found.</p>
                    </div>
                </div>
            </div>

            <!-- Automation Section -->
            <div id="automation" class="content-section">
                <div class="page-header">
                    <h1>Automation Settings</h1>
                    <p>Configure automated file processing and organization</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">File Processing Rules</h2>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto-metadata" checked>
                            Auto-extract metadata from filenames
                        </label>
                        <p style="color: #888; font-size: 14px; margin-top: 5px;">
                            Automatically parse BPM, key, and artist info from filename patterns
                        </p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto-organize" checked>
                            Auto-organize files by type
                        </label>
                        <p style="color: #888; font-size: 14px; margin-top: 5px;">
                            Automatically sort uploads into appropriate folders (beats, stems, artwork)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auto-preview" checked>
                            Auto-generate preview clips
                        </label>
                        <p style="color: #888; font-size: 14px; margin-top: 5px;">
                            Create 30-second preview clips for full beats
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="filename-pattern">Filename Pattern Recognition</label>
                        <textarea id="filename-pattern" class="form-control" rows="4" readonly>
Pattern 1: [Title] - prod by [Artist] - bpm[BPM] - [Key][Scale]
Pattern 2: [Title] - [BPM]BPM - [Key] [Scale] - [Artist]
Pattern 3: [Artist] - [Title] ([Key] [Scale], [BPM] BPM)
Pattern 4: [Title] [Key][Scale] [BPM]BPM prod [Artist]</textarea>
                    </div>

                    <button class="btn btn-primary" onclick="saveAutomationSettings()">Save Settings</button>
                </div>
            </div>

            <!-- Bulk Upload Section -->
            <div id="bulk-upload" class="content-section">
                <div class="page-header">
                    <h1>Bulk Upload - Folder Drop</h1>
                    <p>Drop entire folders to automatically organize your beat catalog</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">Smart Folder Processing</h2>

                    <div class="upload-area" id="bulk-upload-area">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Drop Your 2022 Folder Here</div>
                        <div class="upload-subtext">Drag entire folders - all files will be automatically sorted and organized</div>
                        <div style="margin-top: 15px; font-size: 14px; color: #00FFFF;">
                            ‚ú® Supports: Audio files, Images, ZIP stems, Nested folders
                        </div>
                    </div>
                    <input type="file" id="bulk-files" multiple webkitdirectory directory accept="*/*" style="display: none;">
                    <input type="file" id="bulk-files-single" multiple accept="audio/*,image/*,.zip" style="display: none;">

                    <div style="margin: 20px 0; text-align: center;">
                        <button class="btn btn-secondary" onclick="document.getElementById('bulk-files').click()">
                            üìÅ Browse for Folder
                        </button>
                        <span style="margin: 0 15px; color: #888;">or</span>
                        <button class="btn btn-secondary" onclick="document.getElementById('bulk-files-single').click()">
                            üìÑ Browse for Files
                        </button>
                    </div>

                    <div id="folder-preview" style="display: none; margin: 20px 0;">
                        <h3 style="color: #00FFFF; margin-bottom: 15px;">Folder Contents Preview</h3>
                        <div id="folder-structure"></div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="processFolderContents()">
                                üöÄ Process All Files
                            </button>
                            <button class="btn btn-secondary" onclick="cancelFolderUpload()">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <div id="bulk-progress" style="display: none;">
                        <h3 style="color: #00FFFF; margin: 20px 0;">Processing Files...</h3>
                        <div class="progress-container">
                            <div id="bulk-progress-bar" class="progress-bar"></div>
                        </div>
                        <div id="bulk-status"></div>
                    </div>

                    <div id="bulk-results" style="display: none;">
                        <h3 style="color: #00FFFF; margin: 20px 0;">Processing Complete!</h3>
                        <div id="bulk-results-content"></div>
                    </div>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">How It Works</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="padding: 20px; background: rgba(0,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üéµ</div>
                            <h4 style="color: #00FFFF; margin-bottom: 10px;">Audio Files</h4>
                            <p style="color: #ccc; font-size: 14px;">
                                WAV/FLAC ‚Üí Full beats<br>
                                MP3 ‚Üí Preview clips<br>
                                Auto-extracts BPM, key, genre
                            </p>
                        </div>
                        <div style="padding: 20px; background: rgba(0,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üñºÔ∏è</div>
                            <h4 style="color: #00FFFF; margin-bottom: 10px;">Images</h4>
                            <p style="color: #ccc; font-size: 14px;">
                                JPG/PNG ‚Üí Beat artwork<br>
                                Auto-matches to beats by name<br>
                                Organized in image library
                            </p>
                        </div>
                        <div style="padding: 20px; background: rgba(0,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üì¶</div>
                            <h4 style="color: #00FFFF; margin-bottom: 10px;">ZIP Files</h4>
                            <p style="color: #ccc; font-size: 14px;">
                                ZIP ‚Üí Stem packages<br>
                                Links to matching beats<br>
                                Ready for premium downloads
                            </p>
                        </div>
                        <div style="padding: 20px; background: rgba(0,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ü§ñ</div>
                            <h4 style="color: #00FFFF; margin-bottom: 10px;">Smart Bundling</h4>
                            <p style="color: #ccc; font-size: 14px;">
                                Groups related files together<br>
                                Creates complete products<br>
                                Ready for your store
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dropbox Import Section -->
            <div id="dropbox-import" class="content-section">
                <div class="page-header">
                    <h1>‚òÅÔ∏è Dropbox Import</h1>
                    <p>Import your entire catalog directly from Dropbox without downloading - saves local storage!</p>
                </div>

                <div class="form-container">
                    <!-- Dropbox URL Input -->
                    <div class="form-group">
                        <label for="dropbox-url">Dropbox Folder URL</label>
                        <input type="text" id="dropbox-url" placeholder="https://www.dropbox.com/home/path/to/your/beats"
                               value="https://www.dropbox.com/home/0%20Blais/Music/Blais%20Production/0%20-%20Blais%20Beat%20Store"
                               style="width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; color: white;">
                        <div style="font-size: 12px; color: #888; margin-top: 8px;">
                            Paste any Dropbox folder URL - the system will automatically process all your beats, stems, and artwork
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div id="dropbox-status" style="background: rgba(255,152,0,0.1); border: 1px solid #FF9800; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <h4 style="color: #FF9800;">üì° Connection Status</h4>
                        <div id="dropbox-connection-status">Ready to connect to your Dropbox folder</div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="testDropboxConnection()" style="height: 60px;">
                            üîó Test Connection
                        </button>
                        <button class="btn btn-primary" onclick="previewDropboxFolder()" style="height: 60px;">
                            üëÄ Preview Folder
                        </button>
                        <button class="btn btn-success" onclick="importFromDropbox()" style="height: 60px;">
                            üöÄ Import All Files
                        </button>
                    </div>

                    <!-- Folder Preview -->
                    <div id="dropbox-preview" style="display: none; margin: 20px 0;">
                        <h3 style="color: #00FFFF; margin-bottom: 15px;">üìÅ Folder Contents</h3>
                        <div id="dropbox-file-list" style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; max-height: 400px; overflow-y: auto;">
                            <!-- File list will be populated here -->
                        </div>
                    </div>

                    <!-- Import Progress -->
                    <div id="dropbox-progress" style="display: none; margin: 20px 0;">
                        <h3 style="color: #00FFFF; margin-bottom: 15px;">‚öôÔ∏è Import Progress</h3>
                        <div class="progress-container">
                            <div id="dropbox-progress-bar" class="progress-bar">0%</div>
                        </div>
                        <div id="dropbox-status-text" style="margin-top: 10px; color: #ccc;">Initializing...</div>
                    </div>

                    <!-- Import Results -->
                    <div id="dropbox-results" style="display: none; margin: 20px 0;">
                        <!-- Results will be populated here -->
                    </div>

                    <!-- Processing Log -->
                    <div style="margin: 20px 0;">
                        <h3 style="color: #00FFFF; margin-bottom: 15px;">üìã Processing Log</h3>
                        <div id="dropbox-log" style="background: rgba(0,0,0,0.5); border-radius: 10px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                            <div style="color: #00FFFF;">[Ready] Dropbox importer ready. Enter your folder URL above.</div>
                        </div>
                    </div>

                    <!-- Features List -->
                    <div style="background: rgba(0,255,255,0.1); border: 1px solid rgba(0,255,255,0.3); border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <h4 style="color: #00FFFF; margin-bottom: 15px;">‚ú® Features</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <h5 style="color: #4CAF50;">üîó Direct Processing</h5>
                                <p style="font-size: 13px; color: #ccc;">Access files directly from Dropbox without downloading to your computer</p>
                            </div>
                            <div>
                                <h5 style="color: #4CAF50;">üéØ Smart Organization</h5>
                                <p style="font-size: 13px; color: #ccc;">Automatically extracts metadata and organizes beats by filename patterns</p>
                            </div>
                            <div>
                                <h5 style="color: #4CAF50;">üì¶ Complete Bundles</h5>
                                <p style="font-size: 13px; color: #ccc;">Groups WAV, MP3, stems, and artwork into complete beat packages</p>
                            </div>
                            <div>
                                <h5 style="color: #4CAF50;">üíæ Zero Storage</h5>
                                <p style="font-size: 13px; color: #ccc;">No local storage used - everything stays in the cloud</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="page-header">
                    <h1>Store Settings</h1>
                    <p>Configure your store preferences and integrations</p>
                </div>

                <div class="form-container">
                    <h2 style="color: #00FFFF; margin-bottom: 20px;">General Settings</h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="store-name">Store Name</label>
                            <input type="text" id="store-name" class="form-control" value="Blais Beats">
                        </div>
                        <div class="form-group">
                            <label for="store-email">Contact Email</label>
                            <input type="email" id="store-email" class="form-control">
                        </div>
                        <div class="form-group full-width">
                            <label for="store-description">Store Description</label>
                            <textarea id="store-description" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <h3 style="color: #00FFFF; margin: 30px 0 20px 0;">Pricing Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="default-price">Default Beat Price</label>
                            <input type="number" id="default-price" class="form-control" value="39.99" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="premium-multiplier">Premium License Multiplier</label>
                            <input type="number" id="premium-multiplier" class="form-control" value="6" step="0.1">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://nqoaflctftktlmkexuhz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xb2FmbGN0ZnRrdGxta2V4dWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NDcxNjYsImV4cCI6MjA3NDUyMzE2Nn0.epr6o0qQfz--0SVaqAc6BI9s_LAbrTBUvu7too_ExWM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global Variables
        let bulkDeleteMode = false;
        let selectedImages = new Set();

        // Navigation Functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked nav item
            event.target.classList.add('active');

            // Load section-specific data
            loadSectionData(sectionId);
        }

        // Load data for specific sections
        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'tracks':
                    loadBeats();
                    break;
                case 'collections':
                    loadCollections();
                    break;
                case 'soundkits':
                    loadSoundKits();
                    break;
                case 'photos':
                    loadImageLibrary();
                    break;
                case 'filestorage':
                    loadFileStorage();
                    break;
                case 'sales':
                    loadSalesData();
                    break;
                case 'orders':
                    loadOrdersData();
                    break;
                case 'customers':
                    loadCustomersData();
                    break;
            }
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                // Load beats count
                const { data: beats, error: beatsError } = await supabase
                    .from('beats')
                    .select('id');

                if (!beatsError && beats) {
                    document.getElementById('beats-count').textContent = beats.length;
                }

                // Load recent activity (placeholder)
                document.getElementById('recent-activity').innerHTML = `
                    <div style="color: #888; text-align: center; padding: 20px;">
                        <p>‚ú® Welcome to your new admin dashboard!</p>
                        <p>Start by uploading some beats or organizing your content.</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Beat Management Functions
        let allBeats = [];
        let selectedBeats = new Set();
        let bulkBeatMode = false;

        async function loadBeats() {
            try {
                const { data: beats, error } = await supabase
                    .from('beats')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allBeats = beats || [];
                displayBeats(allBeats);

                // Setup search and filter handlers
                setupBeatsFiltering();

            } catch (error) {
                console.error('Error loading beats:', error);
                document.getElementById('beats-list').innerHTML =
                    `<p style="color: #ff4444; text-align: center; padding: 20px;">Error loading beats: ${error.message}</p>`;
            }
        }

        function displayBeats(beats) {
            const beatsList = document.getElementById('beats-list');

            if (!beats || beats.length === 0) {
                beatsList.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No beats found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            ${bulkBeatMode ? '<th><input type="checkbox" id="select-all-beats-checkbox" onchange="toggleAllBeatsSelection()"></th>' : ''}
                            <th>Title</th>
                            <th>BPM</th>
                            <th>Key</th>
                            <th>Tags</th>
                            <th>Status</th>
                            <th>Files</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${beats.map(beat => {
                            const status = beat.status || 'draft';
                            const statusColor = {
                                'draft': '#888',
                                'published': '#4CAF50',
                                'featured': '#FF9800'
                            }[status] || '#888';

                            const files = [];
                            if (beat.wav_file) files.push('WAV');
                            if (beat.preview_file) files.push('Preview');
                            if (beat.stems_file) files.push('Stems');
                            if (beat.artwork_url) files.push('Artwork');

                            return `
                                <tr>
                                    ${bulkBeatMode ? `<td><input type="checkbox" class="beat-checkbox" data-beat-id="${beat.id}" onchange="toggleBeatSelection('${beat.id}', this)"></td>` : ''}
                                    <td>
                                        <div><strong>${beat.title}</strong></div>
                                        ${beat.description ? `<div style="font-size: 12px; color: #888; margin-top: 2px;">${beat.description.substring(0, 60)}${beat.description.length > 60 ? '...' : ''}</div>` : ''}
                                    </td>
                                    <td>${beat.bpm || '-'}</td>
                                    <td>${beat.music_key || '-'} ${beat.scale || ''}</td>
                                    <td><div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${(beat.tags || []).join(', ') || '-'}</div></td>
                                    <td><span style="color: ${statusColor}; font-weight: bold;">${status.toUpperCase()}</span></td>
                                    <td><div style="font-size: 11px;">${files.join(' ‚Ä¢ ') || 'No files'}</div></td>
                                    <td>${new Date(beat.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-secondary" onclick="editBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                                            ${status === 'draft'
                                                ? `<button class="btn btn-primary" onclick="publishBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px;">Publish</button>`
                                                : `<button class="btn btn-secondary" onclick="unpublishBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px;">Unpublish</button>`
                                            }
                                            ${status !== 'featured'
                                                ? `<button class="btn" onclick="featureBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px; background: #FF9800; color: white;">Feature</button>`
                                                : `<button class="btn btn-secondary" onclick="unfeatureBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px;">Unfeature</button>`
                                            }
                                            <button class="btn btn-danger" onclick="deleteBeat('${beat.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            beatsList.innerHTML = tableHTML;
        }

        function setupBeatsFiltering() {
            const searchInput = document.getElementById('beats-search');
            const filterSelect = document.getElementById('beats-filter');

            if (searchInput && filterSelect) {
                const filterBeats = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const statusFilter = filterSelect.value;

                    let filteredBeats = allBeats.filter(beat => {
                        const matchesSearch = !searchTerm ||
                            beat.title.toLowerCase().includes(searchTerm) ||
                            (beat.tags || []).some(tag => tag.toLowerCase().includes(searchTerm)) ||
                            (beat.music_key && beat.music_key.toLowerCase().includes(searchTerm));

                        const matchesStatus = !statusFilter || beat.status === statusFilter;

                        return matchesSearch && matchesStatus;
                    });

                    displayBeats(filteredBeats);
                };

                searchInput.addEventListener('input', filterBeats);
                filterSelect.addEventListener('change', filterBeats);
            }
        }

        // Beat Actions
        async function publishBeat(beatId) {
            try {
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'published' })
                    .eq('id', beatId);

                if (error) throw error;

                showMessage('Beat published successfully!', 'success');
                loadBeats();
            } catch (error) {
                showMessage(`Error publishing beat: ${error.message}`, 'error');
            }
        }

        async function unpublishBeat(beatId) {
            try {
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'draft' })
                    .eq('id', beatId);

                if (error) throw error;

                showMessage('Beat unpublished successfully!', 'success');
                loadBeats();
            } catch (error) {
                showMessage(`Error unpublishing beat: ${error.message}`, 'error');
            }
        }

        async function featureBeat(beatId) {
            try {
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'featured' })
                    .eq('id', beatId);

                if (error) throw error;

                showMessage('Beat featured successfully!', 'success');
                loadBeats();
            } catch (error) {
                showMessage(`Error featuring beat: ${error.message}`, 'error');
            }
        }

        async function unfeatureBeat(beatId) {
            try {
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'published' })
                    .eq('id', beatId);

                if (error) throw error;

                showMessage('Beat unfeatured successfully!', 'success');
                loadBeats();
            } catch (error) {
                showMessage(`Error unfeaturing beat: ${error.message}`, 'error');
            }
        }

        async function deleteBeat(beatId) {
            if (!confirm('Are you sure you want to delete this beat? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('beats')
                    .delete()
                    .eq('id', beatId);

                if (error) throw error;

                showMessage('Beat deleted successfully!', 'success');
                loadBeats();
            } catch (error) {
                showMessage(`Error deleting beat: ${error.message}`, 'error');
            }
        }

        function editBeat(beatId) {
            // Find the beat
            const beat = allBeats.find(b => b.id === beatId);
            if (!beat) return;

            // Pre-fill the form with beat data
            document.getElementById('beat-title').value = beat.title || '';
            document.getElementById('beat-bpm').value = beat.bpm || '';
            document.getElementById('beat-key').value = beat.music_key || '';
            document.getElementById('beat-scale').value = beat.scale || '';
            document.getElementById('beat-tags').value = (beat.tags || []).join(', ');
            document.getElementById('beat-description').value = beat.description || '';

            // Store the ID for updating
            document.getElementById('beat-form').dataset.editingId = beatId;

            // Change the submit button text
            const submitBtn = document.querySelector('#beat-form button[type="submit"]');
            submitBtn.textContent = 'Update Beat';

            // Scroll to form
            document.getElementById('beat-form').scrollIntoView({ behavior: 'smooth' });

            showMessage('Beat loaded for editing. Make your changes and click "Update Beat".', 'info');
        }

        // Bulk Operations
        function toggleBulkBeats() {
            bulkBeatMode = !bulkBeatMode;
            selectedBeats.clear();

            const bulkActionsDiv = document.getElementById('bulk-beats-actions');
            const toggleBtn = document.querySelector('button[onclick="toggleBulkBeats()"]');

            if (bulkBeatMode) {
                bulkActionsDiv.style.display = 'block';
                toggleBtn.textContent = 'Cancel Bulk';
                toggleBtn.classList.add('btn-secondary');
            } else {
                bulkActionsDiv.style.display = 'none';
                toggleBtn.textContent = 'Bulk Actions';
                toggleBtn.classList.remove('btn-secondary');
            }

            displayBeats(allBeats);
        }

        function toggleBeatSelection(beatId, checkbox) {
            if (checkbox.checked) {
                selectedBeats.add(beatId);
            } else {
                selectedBeats.delete(beatId);
            }

            updateBulkButtons();
        }

        function toggleAllBeatsSelection() {
            const selectAllCheckbox = document.getElementById('select-all-beats-checkbox');
            const beatCheckboxes = document.querySelectorAll('.beat-checkbox');

            if (selectAllCheckbox.checked) {
                beatCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedBeats.add(checkbox.dataset.beatId);
                });
            } else {
                beatCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedBeats.delete(checkbox.dataset.beatId);
                });
                selectedBeats.clear();
            }

            updateBulkButtons();
        }

        function updateBulkButtons() {
            const count = selectedBeats.size;

            document.getElementById('publish-selected').disabled = count === 0;
            document.getElementById('publish-selected').textContent = `Publish Selected (${count})`;

            document.getElementById('feature-selected').disabled = count === 0;
            document.getElementById('feature-selected').textContent = `Feature Selected (${count})`;

            document.getElementById('delete-selected-beats').disabled = count === 0;
            document.getElementById('delete-selected-beats').textContent = `Delete Selected (${count})`;
        }

        async function bulkPublishBeats() {
            if (selectedBeats.size === 0) return;

            try {
                const beatIds = Array.from(selectedBeats);
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'published' })
                    .in('id', beatIds);

                if (error) throw error;

                showMessage(`${beatIds.length} beats published successfully!`, 'success');
                selectedBeats.clear();
                loadBeats();
            } catch (error) {
                showMessage(`Error publishing beats: ${error.message}`, 'error');
            }
        }

        async function bulkFeatureBeats() {
            if (selectedBeats.size === 0) return;

            try {
                const beatIds = Array.from(selectedBeats);
                const { error } = await supabase
                    .from('beats')
                    .update({ status: 'featured' })
                    .in('id', beatIds);

                if (error) throw error;

                showMessage(`${beatIds.length} beats featured successfully!`, 'success');
                selectedBeats.clear();
                loadBeats();
            } catch (error) {
                showMessage(`Error featuring beats: ${error.message}`, 'error');
            }
        }

        async function bulkDeleteBeats() {
            if (selectedBeats.size === 0) return;

            const beatIds = Array.from(selectedBeats);
            if (!confirm(`Are you sure you want to delete ${beatIds.length} beats? This action cannot be undone.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('beats')
                    .delete()
                    .in('id', beatIds);

                if (error) throw error;

                showMessage(`${beatIds.length} beats deleted successfully!`, 'success');
                selectedBeats.clear();
                loadBeats();
            } catch (error) {
                showMessage(`Error deleting beats: ${error.message}`, 'error');
            }
        }

        // Collections Management Functions
        let allCollections = [];
        let currentCollectionId = null;

        async function loadCollections() {
            try {
                // Create collections table if it doesn't exist (for demo)
                const { data: collections, error } = await supabase
                    .from('collections')
                    .select(`
                        *,
                        collection_beats (
                            beat_id,
                            beats (title)
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error && error.code === '42P01') {
                    // Table doesn't exist, show placeholder
                    document.getElementById('collections-list').innerHTML = `
                        <div style="text-align: center; color: #888; padding: 40px;">
                            <p>üìö Collections feature will be available once database tables are set up</p>
                            <p style="font-size: 14px;">Collections table not found - this is normal for demo</p>
                        </div>
                    `;
                    return;
                }

                if (error) throw error;

                allCollections = collections || [];
                displayCollections(allCollections);

            } catch (error) {
                console.error('Error loading collections:', error);
                document.getElementById('collections-list').innerHTML =
                    `<p style="color: #ff4444; text-align: center; padding: 20px;">Error loading collections: ${error.message}</p>`;
            }
        }

        function displayCollections(collections) {
            const collectionsList = document.getElementById('collections-list');

            if (!collections || collections.length === 0) {
                collectionsList.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No collections created yet.</p>';
                return;
            }

            const html = `
                <div class="dashboard-grid">
                    ${collections.map(collection => {
                        const beatCount = collection.collection_beats?.length || 0;
                        const typeIcon = {
                            'album': 'üíø',
                            'playlist': 'üìã',
                            'genre': 'üéº',
                            'mood': 'üé≠'
                        }[collection.type] || 'üìö';

                        return `
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-icon">${typeIcon}</div>
                                    <div class="card-title">${collection.name}</div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 24px; color: #00FFFF; margin-bottom: 5px;">${beatCount}</div>
                                    <div style="color: #888; font-size: 14px;">beats in collection</div>
                                </div>
                                <div style="color: #888; font-size: 14px; margin-bottom: 15px;">
                                    ${collection.description || 'No description'}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary" onclick="showCollectionBeatSelection('${collection.id}')" style="flex: 1; font-size: 12px;">Add Beats</button>
                                    <button class="btn btn-secondary" onclick="editCollection('${collection.id}')" style="flex: 1; font-size: 12px;">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteCollection('${collection.id}')" style="flex: 1; font-size: 12px;">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            collectionsList.innerHTML = html;
        }

        function showCollectionBeatSelection(collectionId) {
            currentCollectionId = collectionId;
            document.getElementById('collection-beat-selection').style.display = 'block';
            loadBeatsForCollection();
        }

        function hideCollectionBeatSelection() {
            document.getElementById('collection-beat-selection').style.display = 'none';
            currentCollectionId = null;
        }

        async function loadBeatsForCollection() {
            try {
                const { data: beats } = await supabase
                    .from('beats')
                    .select('*')
                    .eq('status', 'published');

                const beatList = document.getElementById('collection-beat-list');

                if (!beats || beats.length === 0) {
                    beatList.innerHTML = '<p style="color: #888;">No published beats available.</p>';
                    return;
                }

                const html = `
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${beats.map(beat => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid rgba(0,255,255,0.2); border-radius: 5px; margin-bottom: 10px;">
                                <div>
                                    <strong>${beat.title}</strong>
                                    <div style="font-size: 12px; color: #888;">${beat.bpm || '-'} BPM ‚Ä¢ ${beat.music_key || '-'}</div>
                                </div>
                                <button class="btn btn-primary" onclick="addBeatToCollection('${beat.id}')" style="font-size: 12px;">Add</button>
                            </div>
                        `).join('')}
                    </div>
                `;

                beatList.innerHTML = html;
            } catch (error) {
                console.error('Error loading beats for collection:', error);
            }
        }

        async function addBeatToCollection(beatId) {
            if (!currentCollectionId) return;

            try {
                // This would work once the tables are set up
                showMessage('Beat would be added to collection (demo mode)', 'info');
            } catch (error) {
                showMessage(`Error adding beat to collection: ${error.message}`, 'error');
            }
        }

        // Sound Kits Management Functions
        let selectedKitFiles = [];

        async function loadSoundKits() {
            try {
                // Demo data since sound_kits table may not exist
                document.getElementById('soundkits-list').innerHTML = `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <p>üéõÔ∏è Sound Kits feature ready for use</p>
                        <p style="font-size: 14px;">Upload audio files and create your first sound kit above</p>
                    </div>
                `;

                // Setup kit file upload handler
                setupKitFileHandler();

            } catch (error) {
                console.error('Error loading sound kits:', error);
                document.getElementById('soundkits-list').innerHTML =
                    `<p style="color: #ff4444; text-align: center; padding: 20px;">Error loading sound kits: ${error.message}</p>`;
            }
        }

        function setupKitFileHandler() {
            const kitFiles = document.getElementById('kit-files');

            if (kitFiles) {
                kitFiles.addEventListener('change', (e) => {
                    selectedKitFiles = Array.from(e.target.files);
                    displaySelectedKitFiles();
                });
            }
        }

        function displaySelectedKitFiles() {
            const preview = document.getElementById('kit-files-preview');
            const filesList = document.getElementById('kit-files-list');

            if (selectedKitFiles.length === 0) {
                preview.style.display = 'none';
                return;
            }

            preview.style.display = 'block';

            const html = `
                <div style="max-height: 200px; overflow-y: auto;">
                    ${selectedKitFiles.map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                            <div>
                                <div><strong>${file.name}</strong></div>
                                <div style="font-size: 12px; color: #888;">${formatFileSize(file.size)} ‚Ä¢ ${file.type}</div>
                            </div>
                            <button onclick="removeKitFile(${index})" style="background: #f44336; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 11px;">Remove</button>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #888;">
                    Total: ${selectedKitFiles.length} files (${formatFileSize(selectedKitFiles.reduce((total, file) => total + file.size, 0))})
                </div>
            `;

            filesList.innerHTML = html;

            // Auto-fill kit name if not set
            const kitNameInput = document.getElementById('kit-name');
            if (!kitNameInput.value && selectedKitFiles.length > 0) {
                const firstName = selectedKitFiles[0].name;
                const baseName = firstName.replace(/\.[^/.]+$/, '').replace(/[-_]\d+$/, '').replace(/[-_](sample|loop|one|shot).*$/i, '');
                kitNameInput.value = baseName + ' Kit';
            }
        }

        function removeKitFile(index) {
            selectedKitFiles.splice(index, 1);
            displaySelectedKitFiles();

            // Update the file input
            const kitFiles = document.getElementById('kit-files');
            const dt = new DataTransfer();
            selectedKitFiles.forEach(file => dt.items.add(file));
            kitFiles.files = dt.files;
        }

        async function createSoundKit(formData) {
            try {
                // Upload files to storage
                const uploadedFiles = [];

                for (const file of selectedKitFiles) {
                    const fileName = `${Date.now()}_${file.name}`;
                    const { error } = await supabase.storage
                        .from('beats') // Using beats bucket for now
                        .upload(`kits/${fileName}`, file);

                    if (error) throw error;
                    uploadedFiles.push(fileName);
                }

                // Create kit entry (would work once table is set up)
                showMessage(`Sound kit "${formData.name}" created with ${uploadedFiles.length} files!`, 'success');

                // Reset form
                document.getElementById('soundkit-form').reset();
                selectedKitFiles = [];
                displaySelectedKitFiles();

                // Reload kits
                loadSoundKits();

            } catch (error) {
                showMessage(`Error creating sound kit: ${error.message}`, 'error');
            }
        }

        // Form Handlers
        document.addEventListener('DOMContentLoaded', () => {
            // Collection form handler
            const collectionForm = document.getElementById('collection-form');
            if (collectionForm) {
                collectionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const collectionData = {
                        name: document.getElementById('collection-name').value.trim(),
                        type: document.getElementById('collection-type').value,
                        description: document.getElementById('collection-description').value.trim() || null
                    };

                    if (!collectionData.name || !collectionData.type) {
                        showMessage('Please fill in all required fields', 'error');
                        return;
                    }

                    try {
                        // Would create collection once table is set up
                        showMessage(`Collection "${collectionData.name}" would be created (demo mode)`, 'info');
                        collectionForm.reset();
                    } catch (error) {
                        showMessage(`Error creating collection: ${error.message}`, 'error');
                    }
                });
            }

            // Sound kit form handler
            const soundkitForm = document.getElementById('soundkit-form');
            if (soundkitForm) {
                soundkitForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (selectedKitFiles.length === 0) {
                        showMessage('Please select at least one audio file for the kit', 'error');
                        return;
                    }

                    const kitData = {
                        name: document.getElementById('kit-name').value.trim(),
                        genre: document.getElementById('kit-genre').value || null,
                        price: parseFloat(document.getElementById('kit-price').value) || 19.99,
                        bpm_range: document.getElementById('kit-bpm').value.trim() || null,
                        description: document.getElementById('kit-description').value.trim() || null
                    };

                    if (!kitData.name) {
                        showMessage('Please enter a kit name', 'error');
                        return;
                    }

                    await createSoundKit(kitData);
                });
            }
        });

        // Image Management Functions
        async function loadImageLibrary() {
            try {
                const { data: files, error } = await supabase.storage
                    .from('artwork')
                    .list('library/', {
                        limit: 100,
                        sortBy: { column: 'created_at', order: 'desc' }
                    });

                if (error) throw error;

                displayImageLibrary(files || []);

            } catch (error) {
                console.error('Error loading image library:', error);
                document.getElementById('image-grid').innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 40px; grid-column: 1 / -1;">
                        <p>Error loading images: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayImageLibrary(files) {
            const imageGrid = document.getElementById('image-grid');

            if (files.length === 0) {
                imageGrid.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 40px; grid-column: 1 / -1;">
                        <p>No images in library. Upload some images to get started!</p>
                    </div>
                `;
                return;
            }

            imageGrid.innerHTML = '';

            files.forEach(file => {
                if (file.name && !file.name.endsWith('/')) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'image-item';

                    // Get public URL for the image
                    const { data } = supabase.storage
                        .from('artwork')
                        .getPublicUrl(`library/${file.name}`);

                    let imageContent = `<img src="${data.publicUrl}" alt="${file.name}" loading="lazy">`;

                    // Add delete button for individual deletion
                    if (!bulkDeleteMode) {
                        imageContent += `
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteImage('${file.name}')" title="Delete ${file.name}">
                                ‚úï
                            </button>
                        `;
                        imageDiv.onclick = () => selectImage(file.name);
                    }

                    // Add checkbox for bulk selection mode
                    if (bulkDeleteMode) {
                        const isSelected = selectedImages.has(file.name);
                        imageContent += `
                            <input type="checkbox"
                                   class="image-checkbox"
                                   data-image-name="${file.name}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleImageSelection('${file.name}', this)"
                                   onclick="event.stopPropagation()">
                        `;
                        imageDiv.onclick = (e) => {
                            const checkbox = imageDiv.querySelector('.image-checkbox');
                            checkbox.checked = !checkbox.checked;
                            toggleImageSelection(file.name, checkbox);
                        };
                    }

                    imageDiv.innerHTML = imageContent;
                    imageGrid.appendChild(imageDiv);
                }
            });
        }

        // Image deletion functions
        async function deleteImage(imageName) {
            if (!confirm(`Are you sure you want to delete "${imageName}"?`)) {
                return;
            }

            try {
                const { error } = await supabase.storage
                    .from('artwork')
                    .remove([`library/${imageName}`]);

                if (error) throw error;

                showMessage(`Successfully deleted ${imageName}!`, 'success');
                loadImageLibrary();

            } catch (error) {
                console.error('Delete error:', error);
                showMessage(`Failed to delete ${imageName}: ${error.message}`, 'error');
            }
        }

        function toggleBulkDeleteMode() {
            bulkDeleteMode = !bulkDeleteMode;
            selectedImages.clear();

            const deleteBtn = document.getElementById('bulk-delete-btn');
            const bulkActionsDiv = document.getElementById('bulk-delete-actions');

            if (bulkDeleteMode) {
                deleteBtn.textContent = 'Cancel Selection';
                deleteBtn.style.background = '#666';
                bulkActionsDiv.style.display = 'block';
            } else {
                deleteBtn.textContent = 'Delete Images';
                deleteBtn.style.background = '#dc3545';
                bulkActionsDiv.style.display = 'none';
            }

            loadImageLibrary();
        }

        function toggleImageSelection(imageName, checkbox) {
            if (checkbox.checked) {
                selectedImages.add(imageName);
            } else {
                selectedImages.delete(imageName);
            }

            const selectedCount = selectedImages.size;
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const selectAllBtn = document.getElementById('select-all-btn');

            deleteSelectedBtn.disabled = selectedCount === 0;
            deleteSelectedBtn.textContent = `Delete Selected (${selectedCount})`;

            const totalImages = document.querySelectorAll('.image-checkbox').length;
            if (selectedCount === 0) {
                selectAllBtn.textContent = 'Select All';
            } else if (selectedCount === totalImages) {
                selectAllBtn.textContent = 'Deselect All';
            } else {
                selectAllBtn.textContent = `Select All (${selectedCount}/${totalImages})`;
            }
        }

        function selectAllImages() {
            const checkboxes = document.querySelectorAll('.image-checkbox');
            const selectAllBtn = document.getElementById('select-all-btn');

            if (selectedImages.size === checkboxes.length) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    selectedImages.delete(checkbox.dataset.imageName);
                });
                selectAllBtn.textContent = 'Select All';
            } else {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedImages.add(checkbox.dataset.imageName);
                });
                selectAllBtn.textContent = 'Deselect All';
            }

            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            deleteSelectedBtn.disabled = selectedImages.size === 0;
            deleteSelectedBtn.textContent = `Delete Selected (${selectedImages.size})`;
        }

        async function deleteSelectedImages() {
            if (selectedImages.size === 0) return;

            const imageNames = Array.from(selectedImages);
            const confirmMsg = `Are you sure you want to delete ${imageNames.length} image(s)?\n\n${imageNames.join(', ')}`;

            if (!confirm(confirmMsg)) return;

            try {
                const filePaths = imageNames.map(name => `library/${name}`);
                const { error } = await supabase.storage
                    .from('artwork')
                    .remove(filePaths);

                if (error) throw error;

                showMessage(`Successfully deleted ${imageNames.length} images!`, 'success');
                selectedImages.clear();
                toggleBulkDeleteMode();
                loadImageLibrary();

            } catch (error) {
                console.error('Bulk delete error:', error);
                showMessage(`Failed to delete images: ${error.message}`, 'error');
            }
        }

        // File Storage Functions
        let allFiles = [];
        let currentBucket = 'all';
        let currentFolder = '';

        async function loadFileStorage() {
            try {
                // Load all files from all buckets
                const buckets = ['artwork', 'beats', 'previews', 'stems', 'licenses'];
                allFiles = [];
                let totalSize = 0;

                for (const bucket of buckets) {
                    try {
                        const { data: files } = await supabase.storage
                            .from(bucket)
                            .list(bucket === 'artwork' ? 'library/' : '', {
                                limit: 1000,
                                sortBy: { column: 'created_at', order: 'desc' }
                            });

                        if (files) {
                            files.forEach(file => {
                                if (file.name && !file.name.endsWith('/')) {
                                    allFiles.push({
                                        ...file,
                                        bucket,
                                        path: bucket === 'artwork' ? `library/${file.name}` : file.name,
                                        type: getFileTypeFromName(file.name),
                                        size: file.metadata?.size || 0
                                    });
                                    totalSize += file.metadata?.size || 0;
                                }
                            });
                        }
                    } catch (error) {
                        console.log(`Could not load files from ${bucket}:`, error.message);
                    }
                }

                // Update statistics
                updateStorageStatistics(allFiles, totalSize);

                // Display file browser
                displayFileBrowser(allFiles);

                // Setup file browser filtering
                setupFileFiltering();

            } catch (error) {
                console.error('Error loading file storage:', error);
                document.getElementById('file-browser').innerHTML = `
                    <div style="text-align: center; color: #ff4444; padding: 40px;">
                        <p>Error loading file storage: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateStorageStatistics(files, totalSize) {
            const stats = {
                total: files.length,
                audio: files.filter(f => f.type === 'audio').length,
                image: files.filter(f => f.type === 'image').length,
                zip: files.filter(f => f.type === 'zip').length,
                pdf: files.filter(f => f.type === 'pdf').length
            };

            document.getElementById('total-files').textContent = stats.total;
            document.getElementById('audio-files').textContent = stats.audio;
            document.getElementById('image-files').textContent = stats.image;
            document.getElementById('storage-used').textContent = formatFileSize(totalSize);
        }

        function displayFileBrowser(files) {
            const fileBrowser = document.getElementById('file-browser');

            // Filter files by current bucket and folder
            let displayFiles = files;
            if (currentBucket !== 'all') {
                displayFiles = files.filter(f => f.bucket === currentBucket);
            }

            // Group files by bucket for organization
            const groupedFiles = {};
            displayFiles.forEach(file => {
                if (!groupedFiles[file.bucket]) {
                    groupedFiles[file.bucket] = [];
                }
                groupedFiles[file.bucket].push(file);
            });

            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <select id="bucket-filter" class="form-control" style="width: 200px;">
                            <option value="all">All Buckets</option>
                            <option value="artwork">Artwork</option>
                            <option value="beats">Beats</option>
                            <option value="previews">Previews</option>
                            <option value="stems">Stems</option>
                            <option value="licenses">Licenses</option>
                        </select>
                        <input type="text" id="file-search" placeholder="Search files..." class="form-control" style="width: 300px;">
                        <select id="file-type-filter" class="form-control" style="width: 150px;">
                            <option value="">All Types</option>
                            <option value="audio">Audio</option>
                            <option value="image">Images</option>
                            <option value="zip">ZIP Files</option>
                            <option value="pdf">PDFs</option>
                        </select>
                        <button class="btn btn-secondary" onclick="toggleFileActions()">Manage Files</button>
                    </div>
                </div>
            `;

            // Display files grouped by bucket
            Object.entries(groupedFiles).forEach(([bucket, bucketFiles]) => {
                const bucketIcon = {
                    'artwork': 'üñºÔ∏è',
                    'beats': 'üéµ',
                    'previews': 'üîä',
                    'stems': 'üì¶',
                    'licenses': 'üìÑ'
                }[bucket] || 'üìÅ';

                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #00FFFF; margin-bottom: 15px; display: flex; align-items: center;">
                            <span style="margin-right: 10px;">${bucketIcon}</span>
                            ${bucket.charAt(0).toUpperCase() + bucket.slice(1)} (${bucketFiles.length} files)
                        </h3>
                        <div class="file-grid">
                            ${bucketFiles.map(file => `
                                <div class="file-item" onclick="selectFile('${file.bucket}', '${file.path}')">
                                    <div class="file-icon">${getFileIcon(file.type)}</div>
                                    <div class="file-name" title="${file.name}">${file.name}</div>
                                    <div class="file-info">
                                        ${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.created_at).toLocaleDateString()}
                                    </div>
                                    <div style="position: absolute; top: 5px; right: 5px; display: none;" class="file-actions">
                                        <button onclick="event.stopPropagation(); downloadFile('${file.bucket}', '${file.path}')" style="background: #4CAF50; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px; margin-right: 2px;">üì•</button>
                                        <button onclick="event.stopPropagation(); deleteFile('${file.bucket}', '${file.path}')" style="background: #f44336; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 11px;">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            if (Object.keys(groupedFiles).length === 0) {
                html += `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <p>No files found</p>
                    </div>
                `;
            }

            fileBrowser.innerHTML = html;

            // Set current bucket filter value
            const bucketFilter = document.getElementById('bucket-filter');
            if (bucketFilter) {
                bucketFilter.value = currentBucket;
            }
        }

        function setupFileFiltering() {
            const bucketFilter = document.getElementById('bucket-filter');
            const fileSearch = document.getElementById('file-search');
            const typeFilter = document.getElementById('file-type-filter');

            const filterFiles = () => {
                currentBucket = bucketFilter?.value || 'all';
                const searchTerm = fileSearch?.value.toLowerCase() || '';
                const typeFilter_value = typeFilter?.value || '';

                let filteredFiles = allFiles.filter(file => {
                    const matchesBucket = currentBucket === 'all' || file.bucket === currentBucket;
                    const matchesSearch = !searchTerm || file.name.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter_value || file.type === typeFilter_value;

                    return matchesBucket && matchesSearch && matchesType;
                });

                displayFileBrowser(filteredFiles);
            };

            bucketFilter?.addEventListener('change', filterFiles);
            fileSearch?.addEventListener('input', filterFiles);
            typeFilter?.addEventListener('change', filterFiles);
        }

        function getFileTypeFromName(filename) {
            const ext = filename.toLowerCase().split('.').pop();

            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) return 'image';
            if (['mp3', 'wav', 'flac', 'aac', 'm4a'].includes(ext)) return 'audio';
            if (['zip', 'rar', '7z'].includes(ext)) return 'zip';
            if (['pdf'].includes(ext)) return 'pdf';
            if (['txt', 'md', 'json'].includes(ext)) return 'text';

            return 'other';
        }

        function getFileIcon(type) {
            const icons = {
                'audio': 'üéµ',
                'image': 'üñºÔ∏è',
                'zip': 'üì¶',
                'pdf': 'üìÑ',
                'text': 'üìù',
                'other': 'üìé'
            };
            return icons[type] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function selectFile(bucket, path) {
            console.log('Selected file:', { bucket, path });
            // Could open preview modal or file details
        }

        async function downloadFile(bucket, path) {
            try {
                const { data } = await supabase.storage
                    .from(bucket)
                    .createSignedUrl(path, 60); // 1 minute expiry

                if (data?.signedUrl) {
                    window.open(data.signedUrl, '_blank');
                }
            } catch (error) {
                showMessage(`Error downloading file: ${error.message}`, 'error');
            }
        }

        async function deleteFile(bucket, path) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            try {
                const { error } = await supabase.storage
                    .from(bucket)
                    .remove([path]);

                if (error) throw error;

                showMessage('File deleted successfully!', 'success');
                loadFileStorage(); // Refresh
            } catch (error) {
                showMessage(`Error deleting file: ${error.message}`, 'error');
            }
        }

        function toggleFileActions() {
            const fileActions = document.querySelectorAll('.file-actions');
            const button = document.querySelector('button[onclick="toggleFileActions()"]');

            fileActions.forEach(action => {
                if (action.style.display === 'none' || !action.style.display) {
                    action.style.display = 'block';
                    button.textContent = 'Hide Actions';
                } else {
                    action.style.display = 'none';
                    button.textContent = 'Manage Files';
                }
            });
        }

        // Sales and Analytics Functions
        async function loadSalesData() {
            // Placeholder for sales data
            document.getElementById('sales-table').innerHTML = `
                <div style="text-align: center; color: #888; padding: 40px;">
                    <p>üí∞ Sales tracking system coming soon...</p>
                    <p style="font-size: 14px;">Integration with Stripe webhooks and order tracking</p>
                </div>
            `;
        }

        async function loadOrdersData() {
            // Placeholder for orders data
            document.getElementById('orders-table').innerHTML = `
                <div style="text-align: center; color: #888; padding: 40px;">
                    <p>üìã Order management system coming soon...</p>
                    <p style="font-size: 14px;">Track order status, customer info, and fulfillment</p>
                </div>
            `;
        }

        async function loadCustomersData() {
            // Placeholder for customers data
            document.getElementById('customers-table').innerHTML = `
                <div style="text-align: center; color: #888; padding: 40px;">
                    <p>üë• Customer database coming soon...</p>
                    <p style="font-size: 14px;">Manage customer profiles, purchase history, and communications</p>
                </div>
            `;
        }

        // Form Functions
        function clearBeatForm() {
            document.getElementById('beat-form').reset();
            delete document.getElementById('beat-form').dataset.editingId;

            // Reset button text
            const submitBtn = document.querySelector('#beat-form button[type="submit"]');
            submitBtn.textContent = 'Save Beat';
        }

        // Handle beat form submission
        document.addEventListener('DOMContentLoaded', () => {
            const beatForm = document.getElementById('beat-form');

            beatForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const editingId = beatForm.dataset.editingId;
                const isEditing = !!editingId;

                const beatData = {
                    title: document.getElementById('beat-title').value.trim(),
                    bpm: parseInt(document.getElementById('beat-bpm').value) || null,
                    music_key: document.getElementById('beat-key').value || null,
                    scale: document.getElementById('beat-scale').value || null,
                    tags: document.getElementById('beat-tags').value
                        .split(',')
                        .map(tag => tag.trim())
                        .filter(tag => tag.length > 0),
                    description: document.getElementById('beat-description').value.trim() || null
                };

                // Validate required fields
                if (!beatData.title) {
                    showMessage('Please enter a beat title', 'error');
                    return;
                }

                try {
                    const submitBtn = document.querySelector('#beat-form button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEditing ? 'Updating...' : 'Saving...';

                    if (isEditing) {
                        // Update existing beat
                        const { error } = await supabase
                            .from('beats')
                            .update(beatData)
                            .eq('id', editingId);

                        if (error) throw error;

                        showMessage('Beat updated successfully!', 'success');
                    } else {
                        // Create new beat
                        beatData.status = 'draft';

                        const { error } = await supabase
                            .from('beats')
                            .insert(beatData);

                        if (error) throw error;

                        showMessage('Beat created successfully!', 'success');
                    }

                    // Reset form and reload beats
                    clearBeatForm();
                    loadBeats();

                } catch (error) {
                    console.error('Error saving beat:', error);
                    showMessage(`Error ${isEditing ? 'updating' : 'creating'} beat: ${error.message}`, 'error');
                } finally {
                    const submitBtn = document.querySelector('#beat-form button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEditing ? 'Update Beat' : 'Save Beat';
                }
            });

            // Initialize dashboard
            loadDashboardData();
            setupFileUploadHandlers();
        });

        function saveAutomationSettings() {
            showMessage('Automation settings saved successfully!', 'success');
        }

        function saveSettings() {
            showMessage('Store settings saved successfully!', 'success');
        }

        // Utility Functions
        function showMessage(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;

            document.body.appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        function selectImage(imageName) {
            // Image selection logic for beat covers
            console.log('Selected image:', imageName);
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            setupFileUploadHandlers();
        });

        // File Upload Handlers
        let pendingFolderFiles = [];

        function setupFileUploadHandlers() {
            // Image upload handler
            const imageUploadArea = document.getElementById('image-upload-area');
            const imageFiles = document.getElementById('image-files');

            imageUploadArea.onclick = () => imageFiles.click();

            imageFiles.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    uploadImages(files);
                }
            };

            // Drag and drop for images
            setupDragDrop(imageUploadArea, imageFiles);

            // Beat files upload
            const beatFiles = document.getElementById('beat-files');
            beatFiles.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    handleBeatFiles(files);
                }
            };

            // Enhanced Bulk upload handler with folder support
            const bulkUploadArea = document.getElementById('bulk-upload-area');
            const bulkFiles = document.getElementById('bulk-files');
            const bulkFilesSingle = document.getElementById('bulk-files-single');

            bulkUploadArea.onclick = () => bulkFiles.click();

            // Folder upload handler
            bulkFiles.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    showFolderPreview(files);
                }
            };

            // Single files upload handler
            bulkFilesSingle.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    processBulkUpload(files);
                }
            };

            setupAdvancedDragDrop(bulkUploadArea, bulkFiles);
        }

        function showFolderPreview(files) {
            pendingFolderFiles = files;

            // Organize files by type and folder structure
            const fileStats = analyzeFiles(files);

            document.getElementById('folder-preview').style.display = 'block';
            document.getElementById('folder-structure').innerHTML = generateFolderPreview(fileStats);
        }

        function analyzeFiles(files) {
            const stats = {
                total: files.length,
                audio: [],
                images: [],
                zips: [],
                folders: new Set(),
                structure: {}
            };

            files.forEach(file => {
                // Get folder path
                const pathParts = file.webkitRelativePath.split('/');
                const folder = pathParts.slice(0, -1).join('/') || 'root';
                stats.folders.add(folder);

                // Categorize file
                const fileType = getFileTypeFromName(file.name);
                const fileInfo = {
                    name: file.name,
                    path: file.webkitRelativePath,
                    folder: folder,
                    size: file.size,
                    type: fileType
                };

                switch (fileType) {
                    case 'audio':
                        stats.audio.push(fileInfo);
                        break;
                    case 'image':
                        stats.images.push(fileInfo);
                        break;
                    case 'zip':
                        stats.zips.push(fileInfo);
                        break;
                }

                // Build folder structure
                if (!stats.structure[folder]) {
                    stats.structure[folder] = { audio: 0, images: 0, zips: 0, other: 0 };
                }
                stats.structure[folder][fileType] = (stats.structure[folder][fileType] || 0) + 1;
            });

            return stats;
        }

        function generateFolderPreview(stats) {
            const totalSize = pendingFolderFiles.reduce((sum, file) => sum + file.size, 0);

            let html = `
                <div style="background: rgba(0,255,255,0.1); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #00FFFF; margin-bottom: 15px;">üìä Folder Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; color: #00FFFF;">${stats.total}</div>
                            <div style="color: #888; font-size: 12px;">Total Files</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; color: #4CAF50;">${stats.audio.length}</div>
                            <div style="color: #888; font-size: 12px;">Audio Files</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; color: #FF9800;">${stats.images.length}</div>
                            <div style="color: #888; font-size: 12px;">Images</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; color: #9C27B0;">${stats.zips.length}</div>
                            <div style="color: #888; font-size: 12px;">ZIP Files</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; color: #888;">${formatFileSize(totalSize)}</div>
                            <div style="color: #888; font-size: 12px;">Total Size</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px;">
                    <h5 style="color: #00FFFF; margin-bottom: 10px;">üìÅ Folder Structure</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;

            // Show folder structure
            Object.entries(stats.structure).forEach(([folder, counts]) => {
                const folderName = folder === 'root' ? 'üìÅ Root Folder' : `üìÅ ${folder}`;
                const total = counts.audio + counts.images + counts.zips + (counts.other || 0);

                html += `
                    <div style="padding: 8px; margin-bottom: 5px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                        <div style="font-weight: bold; color: #fff;">${folderName}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">
                            ${total} files:
                            ${counts.audio ? `${counts.audio} audio` : ''}
                            ${counts.images ? ` ‚Ä¢ ${counts.images} images` : ''}
                            ${counts.zips ? ` ‚Ä¢ ${counts.zips} zips` : ''}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            // Smart recommendations
            const recommendations = generateRecommendations(stats);
            if (recommendations.length > 0) {
                html += `
                    <div style="background: rgba(0,255,255,0.1); border-radius: 10px; padding: 15px; margin-top: 15px;">
                        <h5 style="color: #00FFFF; margin-bottom: 10px;">üí° Smart Recommendations</h5>
                        ${recommendations.map(rec => `<div style="color: #ccc; font-size: 14px; margin-bottom: 5px;">‚Ä¢ ${rec}</div>`).join('')}
                    </div>
                `;
            }

            return html;
        }

        function generateRecommendations(stats) {
            const recommendations = [];

            if (stats.audio.length > 0) {
                recommendations.push(`${stats.audio.length} audio files will be analyzed for BPM, key, and genre`);
            }

            if (stats.images.length > 0) {
                recommendations.push(`${stats.images.length} images will be stored as artwork and auto-matched to beats`);
            }

            if (stats.zips.length > 0) {
                recommendations.push(`${stats.zips.length} ZIP files will be linked as stem packages`);
            }

            // Check for potential beat bundles
            const potentialBundles = findPotentialBundles(stats.audio.concat(stats.images, stats.zips));
            if (potentialBundles > 0) {
                recommendations.push(`${potentialBundles} potential beat bundles detected - files will be auto-grouped`);
            }

            return recommendations;
        }

        function findPotentialBundles(files) {
            const baseNames = new Set();
            files.forEach(file => {
                const baseName = getBaseName(file.name);
                baseNames.add(baseName.toLowerCase());
            });
            return Math.min(baseNames.size, Math.floor(files.length / 2));
        }

        function cancelFolderUpload() {
            document.getElementById('folder-preview').style.display = 'none';
            pendingFolderFiles = [];

            // Reset file inputs
            document.getElementById('bulk-files').value = '';
            document.getElementById('bulk-files-single').value = '';
        }

        function processFolderContents() {
            if (pendingFolderFiles.length === 0) {
                showMessage('No files to process', 'error');
                return;
            }

            // Hide preview and start processing
            document.getElementById('folder-preview').style.display = 'none';
            processBulkUpload(pendingFolderFiles);

            pendingFolderFiles = [];
        }

        function setupAdvancedDragDrop(area, input) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });

            area.addEventListener('drop', (e) => {
                const files = [];

                // Handle folder drops
                if (e.dataTransfer.items) {
                    for (let i = 0; i < e.dataTransfer.items.length; i++) {
                        const item = e.dataTransfer.items[i];
                        if (item.kind === 'file') {
                            const entry = item.webkitGetAsEntry();
                            if (entry) {
                                if (entry.isDirectory) {
                                    // Show message about folder support
                                    showMessage('üìÅ To upload folders, please use the "Browse for Folder" button (browser limitation)', 'info');
                                    return;
                                } else {
                                    files.push(item.getAsFile());
                                }
                            }
                        }
                    }
                }

                // Fallback to regular file handling
                if (files.length === 0) {
                    const dragFiles = Array.from(e.dataTransfer.files);
                    files.push(...dragFiles);
                }

                if (files.length > 0) {
                    processBulkUpload(files);
                }
            });
        }

        function setupDragDrop(area, input) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
            });

            area.addEventListener('drop', (e) => {
                const files = Array.from(e.dataTransfer.files);
                handleDroppedFiles(files, input);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDroppedFiles(files, input) {
            if (input.id === 'image-files') {
                const imageFiles = files.filter(f => f.type.startsWith('image/'));
                if (imageFiles.length > 0) uploadImages(imageFiles);
            } else if (input.id === 'bulk-files') {
                processBulkUpload(files);
            }
        }

        // Upload Functions
        async function uploadImages(files) {
            for (const file of files) {
                try {
                    const fileName = `${Date.now()}_${file.name}`;
                    const filePath = `library/${fileName}`;

                    const { error } = await supabase.storage
                        .from('artwork')
                        .upload(filePath, file);

                    if (error) throw error;

                    showMessage(`Uploaded ${file.name}`, 'success');
                } catch (error) {
                    showMessage(`Failed to upload ${file.name}: ${error.message}`, 'error');
                }
            }

            loadImageLibrary();
        }

        function handleBeatFiles(files) {
            // Auto-fill metadata based on filename
            if (files.length > 0) {
                const file = files[0];
                const metadata = extractMetadataFromFilename(file.name);

                if (metadata.title) document.getElementById('beat-title').value = metadata.title;
                if (metadata.bpm) document.getElementById('beat-bpm').value = metadata.bpm;
                if (metadata.key) document.getElementById('beat-key').value = metadata.key;
                if (metadata.scale) document.getElementById('beat-scale').value = metadata.scale;
            }

            showMessage(`${files.length} beat file(s) ready for upload`, 'info');
        }

        function extractMetadataFromFilename(filename) {
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
            const metadata = {};

            // Pattern matching for different filename formats
            const patterns = [
                /^(.+?)\s*-\s*prod\s*by\s*\w+\s*-\s*bpm(\d+)\s*-\s*([A-G][#b]?)(\w+)$/i,
                /^(.+?)\s*-\s*(\d+)\s*bpm\s*-\s*([A-G][#b]?)\s*(\w+)/i,
                /^(.+?)\s*\(([A-G][#b]?)\s*(\w+),?\s*(\d+)\s*bpm\)/i,
                /^(.+?)\s*([A-G][#b]?)(\w+)\s*(\d+)bpm/i
            ];

            for (const pattern of patterns) {
                const match = nameWithoutExt.match(pattern);
                if (match) {
                    metadata.title = match[1]?.trim();
                    metadata.bpm = parseInt(match[2]) || parseInt(match[4]);
                    metadata.key = match[3];
                    metadata.scale = match[4]?.toLowerCase() === 'minor' ? 'minor' : 'major';
                    break;
                }
            }

            return metadata;
        }

        async function processBulkUpload(files) {
            const progressDiv = document.getElementById('bulk-progress');
            const progressBar = document.getElementById('bulk-progress-bar');
            const statusDiv = document.getElementById('bulk-status');
            const resultsDiv = document.getElementById('bulk-results');
            const resultsContent = document.getElementById('bulk-results-content');

            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            let processed = 0;
            const total = files.length;
            const results = {
                beats: [],
                images: [],
                stems: [],
                errors: []
            };

            for (const file of files) {
                try {
                    statusDiv.textContent = `Processing ${file.name}...`;
                    const result = await processFile(file);

                    if (result.success) {
                        switch (result.type) {
                            case 'audio':
                                results.beats.push({
                                    name: file.name,
                                    metadata: result.metadata,
                                    bucket: file.name.toLowerCase().includes('preview') ? 'previews' : 'beats'
                                });
                                break;
                            case 'image':
                                results.images.push({
                                    name: file.name,
                                    metadata: result.metadata
                                });
                                break;
                            case 'zip':
                                results.stems.push({
                                    name: file.name,
                                    metadata: result.metadata
                                });
                                break;
                        }
                    } else {
                        results.errors.push(result);
                    }

                    processed++;
                    const percent = (processed / total) * 100;
                    progressBar.style.width = percent + '%';
                    statusDiv.textContent = `Processed ${processed}/${total} files`;

                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    results.errors.push({ fileName: file.name, error: error.message });
                    processed++;
                }
            }

            // Show detailed results
            displayBulkResults(results);

            showMessage(`Bulk upload complete! Processed ${processed} files.`, 'success');

            setTimeout(() => {
                progressDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
            }, 1000);

            // Refresh the beats list if we're on that tab
            if (document.getElementById('tracks').classList.contains('active')) {
                loadBeats();
            }
        }

        function displayBulkResults(results) {
            const resultsContent = document.getElementById('bulk-results-content');

            let html = '';

            // Beats/Audio files
            if (results.beats.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #00FFFF; margin-bottom: 10px;">üéµ Audio Files Processed (${results.beats.length})</h4>
                        <div class="data-table">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>File</th>
                                        <th>Title</th>
                                        <th>BPM</th>
                                        <th>Key</th>
                                        <th>Tags</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.beats.map(beat => `
                                        <tr>
                                            <td><code>${beat.name}</code></td>
                                            <td><strong>${beat.metadata.title || 'Auto-detected'}</strong></td>
                                            <td>${beat.metadata.bpm || '-'}</td>
                                            <td>${beat.metadata.key || '-'} ${beat.metadata.scale || ''}</td>
                                            <td>${(beat.metadata.tags || []).join(', ') || '-'}</td>
                                            <td><span style="color: #4CAF50;">${beat.bucket}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Images
            if (results.images.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #00FFFF; margin-bottom: 10px;">üñºÔ∏è Images Processed (${results.images.length})</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            ${results.images.map(img => `
                                <div style="padding: 10px; background: rgba(0,255,255,0.1); border-radius: 8px; text-align: center;">
                                    <code style="font-size: 12px;">${img.name}</code>
                                    <div style="color: #4CAF50; margin-top: 5px;">‚úì Uploaded to artwork/library</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Stems/ZIP files
            if (results.stems.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #00FFFF; margin-bottom: 10px;">üì¶ Stem Packages (${results.stems.length})</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            ${results.stems.map(stem => `
                                <div style="padding: 15px; background: rgba(0,255,255,0.1); border-radius: 8px;">
                                    <code>${stem.name}</code>
                                    <div style="color: #4CAF50; margin-top: 5px;">‚úì Uploaded to stems bucket</div>
                                    ${stem.metadata.title ? `<div style="color: #888; font-size: 12px;">Linked to: ${stem.metadata.title}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Errors
            if (results.errors.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #ff4444; margin-bottom: 10px;">‚ùå Errors (${results.errors.length})</h4>
                        <div style="background: rgba(244,67,54,0.1); border: 1px solid #f44336; border-radius: 8px; padding: 15px;">
                            ${results.errors.map(error => `
                                <div style="margin-bottom: 10px;">
                                    <code>${error.fileName}</code>: <span style="color: #ff4444;">${error.error}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Summary
            const totalSuccessful = results.beats.length + results.images.length + results.stems.length;
            html += `
                <div style="text-align: center; margin-top: 20px; padding: 20px; background: rgba(0,255,255,0.1); border-radius: 10px;">
                    <h3 style="color: #00FFFF; margin-bottom: 10px;">üìä Processing Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 24px; color: #4CAF50;">${totalSuccessful}</div>
                            <div style="color: #888;">Successful</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #ff4444;">${results.errors.length}</div>
                            <div style="color: #888;">Errors</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #00FFFF;">${results.beats.length}</div>
                            <div style="color: #888;">Beats Created</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #00FFFF;">${results.images.length}</div>
                            <div style="color: #888;">Images Stored</div>
                        </div>
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;
        }

        // Advanced File Processing with Smart Routing
        async function processFile(file) {
            const isImage = file.type.startsWith('image/');
            const isAudio = file.type.startsWith('audio/');
            const isZip = file.name.toLowerCase().endsWith('.zip');

            // Extract metadata first
            const metadata = extractMetadataFromFilename(file.name);
            const baseName = getBaseName(file.name);

            try {
                if (isImage) {
                    await processImageFile(file, metadata);
                } else if (isAudio) {
                    await processAudioFile(file, metadata, baseName);
                } else if (isZip) {
                    await processZipFile(file, metadata, baseName);
                }

                return { success: true, type: getFileType(file), metadata };
            } catch (error) {
                return { success: false, error: error.message, fileName: file.name };
            }
        }

        async function processImageFile(file, metadata) {
            const fileName = `${Date.now()}_${file.name}`;
            const { error } = await supabase.storage
                .from('artwork')
                .upload(`library/${fileName}`, file);

            if (error) throw error;
        }

        async function processAudioFile(file, metadata, baseName) {
            const isPreview = file.name.toLowerCase().includes('preview') ||
                             file.name.toLowerCase().includes('prev') ||
                             file.type === 'audio/mpeg';

            const bucket = isPreview ? 'previews' : 'beats';
            const fileName = `${Date.now()}_${file.name}`;

            const { error } = await supabase.storage
                .from(bucket)
                .upload(fileName, file);

            if (error) throw error;

            // Check if this completes a beat bundle
            await checkAndCreateBeatBundle(baseName, metadata, fileName, bucket);
        }

        async function processZipFile(file, metadata, baseName) {
            const fileName = `${Date.now()}_${file.name}`;
            const { error } = await supabase.storage
                .from('stems')
                .upload(fileName, file);

            if (error) throw error;

            // Link to existing beat if found
            await linkStemsToExistingBeat(baseName, fileName);
        }

        // Smart Beat Bundling System
        async function checkAndCreateBeatBundle(baseName, metadata, fileName, bucket) {
            // Check if beat already exists with this base name
            const { data: existingBeat } = await supabase
                .from('beats')
                .select('*')
                .ilike('title', `%${baseName}%`)
                .single();

            if (existingBeat) {
                // Update existing beat with new file
                const updateData = {};
                if (bucket === 'beats') {
                    updateData.wav_file = fileName;
                } else if (bucket === 'previews') {
                    updateData.preview_file = fileName;
                }

                await supabase
                    .from('beats')
                    .update(updateData)
                    .eq('id', existingBeat.id);
            } else {
                // Create new beat entry
                const newBeat = {
                    title: metadata.title || baseName,
                    bpm: metadata.bpm,
                    music_key: metadata.key,
                    scale: metadata.scale,
                    tags: metadata.tags || [],
                    file_size: 0, // Will be calculated
                    status: 'draft'
                };

                if (bucket === 'beats') {
                    newBeat.wav_file = fileName;
                } else if (bucket === 'previews') {
                    newBeat.preview_file = fileName;
                }

                const { data: insertedBeat } = await supabase
                    .from('beats')
                    .insert(newBeat)
                    .select()
                    .single();

                // Auto-assign artwork if available
                await autoAssignArtwork(insertedBeat.id, baseName);
            }
        }

        async function linkStemsToExistingBeat(baseName, fileName) {
            const { data: beat } = await supabase
                .from('beats')
                .select('id')
                .ilike('title', `%${baseName}%`)
                .single();

            if (beat) {
                await supabase
                    .from('beats')
                    .update({ stems_file: fileName })
                    .eq('id', beat.id);
            }
        }

        async function autoAssignArtwork(beatId, baseName) {
            try {
                const { data: artworkFiles } = await supabase.storage
                    .from('artwork')
                    .list('library/');

                // Look for matching artwork
                const matchingArtwork = artworkFiles?.find(file =>
                    file.name.toLowerCase().includes(baseName.toLowerCase()) ||
                    baseName.toLowerCase().includes(file.name.toLowerCase().split('.')[0])
                );

                if (matchingArtwork) {
                    await supabase
                        .from('beats')
                        .update({ artwork_url: `artwork/library/${matchingArtwork.name}` })
                        .eq('id', beatId);
                }
            } catch (error) {
                console.log('Could not auto-assign artwork:', error);
            }
        }

        // Enhanced Metadata Extraction
        function extractMetadataFromFilename(filename) {
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, "");
            const metadata = {};

            // More comprehensive patterns
            const patterns = [
                // "Track Name - prod by Blais - bpm110 - Ebminor"
                {
                    regex: /^(.+?)\s*-\s*prod\s*by\s*(\w+)\s*-\s*bpm(\d+)\s*-\s*([A-G][#b]?)(\w+)$/i,
                    map: (m) => ({ title: m[1], artist: m[2], bpm: parseInt(m[3]), key: m[4], scale: m[5].toLowerCase() })
                },
                // "Track Name - 120BPM - A Minor"
                {
                    regex: /^(.+?)\s*-\s*(\d+)\s*bpm\s*-\s*([A-G][#b]?)\s*(\w+)/i,
                    map: (m) => ({ title: m[1], bpm: parseInt(m[2]), key: m[3], scale: m[4].toLowerCase() })
                },
                // "Track Name (A Minor, 120 BPM)"
                {
                    regex: /^(.+?)\s*\(([A-G][#b]?)\s*(\w+),?\s*(\d+)\s*bpm\)/i,
                    map: (m) => ({ title: m[1], key: m[2], scale: m[3].toLowerCase(), bpm: parseInt(m[4]) })
                },
                // "Track Name Aminor 120BPM"
                {
                    regex: /^(.+?)\s*([A-G][#b]?)(\w+)\s*(\d+)bpm/i,
                    map: (m) => ({ title: m[1], key: m[2], scale: m[3].toLowerCase(), bpm: parseInt(m[4]) })
                },
                // Just BPM: "Track Name 120"
                {
                    regex: /^(.+?)\s*(\d{2,3})$/,
                    map: (m) => ({ title: m[1], bpm: parseInt(m[2]) })
                }
            ];

            for (const pattern of patterns) {
                const match = nameWithoutExt.match(pattern.regex);
                if (match) {
                    Object.assign(metadata, pattern.map(match));
                    break;
                }
            }

            // Auto-detect genre from keywords
            metadata.tags = detectGenreTags(nameWithoutExt);

            // Fallback title
            if (!metadata.title) {
                metadata.title = nameWithoutExt.replace(/[_-]/g, ' ').replace(/\s+/g, ' ').trim();
            }

            return metadata;
        }

        function detectGenreTags(filename) {
            const tags = [];
            const lowerName = filename.toLowerCase();

            const genreKeywords = {
                'trap': ['trap', 'trapbeat'],
                'drill': ['drill', 'ukdrill', 'nydrill'],
                'lofi': ['lofi', 'lo-fi', 'chill', 'study'],
                'boom-bap': ['boombap', 'boom', 'bap', '90s'],
                'gospel': ['gospel', 'church', 'spiritual'],
                'rnb': ['rnb', 'r&b', 'soul', 'smooth'],
                'pop': ['pop', 'radio', 'commercial'],
                'rock': ['rock', 'guitar', 'band'],
                'piano': ['piano', 'keys', 'acoustic'],
                'dark': ['dark', 'evil', 'horror', 'scary'],
                'emotional': ['emotional', 'sad', 'love', 'heart'],
                'hard': ['hard', 'aggressive', 'heavy'],
                'melodic': ['melodic', 'melody', 'beautiful']
            };

            for (const [tag, keywords] of Object.entries(genreKeywords)) {
                if (keywords.some(keyword => lowerName.includes(keyword))) {
                    tags.push(tag);
                }
            }

            return tags;
        }

        function getBaseName(filename) {
            return filename
                .replace(/\.[^/.]+$/, '') // Remove extension
                .replace(/[-_](preview|prev|stems?|wav|mp3)$/i, '') // Remove common suffixes
                .replace(/[-_]\d{4,}$/, '') // Remove timestamps
                .trim();
        }

        function getFileType(file) {
            if (file.type.startsWith('image/')) return 'image';
            if (file.type.startsWith('audio/')) return 'audio';
            if (file.name.toLowerCase().endsWith('.zip')) return 'zip';
            return 'other';
        }

        // ===== DROPBOX IMPORT FUNCTIONS =====

        function logDropbox(message, type = 'info') {
            const logDiv = document.getElementById('dropbox-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.color = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#00FFFF';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testDropboxConnection() {
            const url = document.getElementById('dropbox-url').value;
            if (!url) {
                logDropbox('Please enter a Dropbox folder URL', 'error');
                return;
            }

            logDropbox('üîó Testing connection to Dropbox...', 'info');

            try {
                const response = await supabase.functions.invoke('dropbox-catalog-processor', {
                    body: {
                        action: 'list_files',
                        folderUrl: url
                    }
                });

                if (response.error) {
                    throw new Error(response.error.message);
                }

                const statusDiv = document.getElementById('dropbox-connection-status');
                statusDiv.innerHTML = '‚úÖ Connection successful! Folder accessible.';
                statusDiv.parentElement.style.background = 'rgba(76,175,80,0.1)';
                statusDiv.parentElement.style.borderColor = '#4CAF50';

                logDropbox('‚úÖ Connection test successful', 'success');
                logDropbox(`üìÅ Found ${response.data.files?.length || 0} files in folder`, 'info');

            } catch (error) {
                const statusDiv = document.getElementById('dropbox-connection-status');
                statusDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                statusDiv.parentElement.style.background = 'rgba(244,67,54,0.1)';
                statusDiv.parentElement.style.borderColor = '#f44336';

                logDropbox(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function previewDropboxFolder() {
            const url = document.getElementById('dropbox-url').value;
            if (!url) {
                logDropbox('Please enter a Dropbox folder URL', 'error');
                return;
            }

            logDropbox('üëÄ Loading folder preview...', 'info');

            try {
                const response = await supabase.functions.invoke('dropbox-catalog-processor', {
                    body: {
                        action: 'list_files',
                        folderUrl: url
                    }
                });

                if (response.error) {
                    throw new Error(response.error.message);
                }

                const files = response.data.files || [];
                displayDropboxFiles(files);
                document.getElementById('dropbox-preview').style.display = 'block';

                logDropbox(`üìÅ Preview loaded: ${files.length} files found`, 'success');

            } catch (error) {
                logDropbox(`‚ùå Preview failed: ${error.message}`, 'error');
            }
        }

        function displayDropboxFiles(files) {
            const listDiv = document.getElementById('dropbox-file-list');

            if (files.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No files found in folder</div>';
                return;
            }

            // Group files by type and folder
            const fileTypes = {
                audio: files.filter(f => getFileTypeFromName(f.name) === 'audio'),
                image: files.filter(f => getFileTypeFromName(f.name) === 'image'),
                zip: files.filter(f => getFileTypeFromName(f.name) === 'zip'),
                other: files.filter(f => !['audio', 'image', 'zip'].includes(getFileTypeFromName(f.name)))
            };

            // Analyze folder structure
            const catalogFolders = {
                '2022': files.filter(f => f.path.includes('2022')),
                '2025': files.filter(f => f.path.includes('2025')),
                'other': files.filter(f => !f.path.includes('2022') && !f.path.includes('2025'))
            };

            const subfolders = {
                wavs: files.filter(f => f.path.includes('/wavs/')),
                mp3s: files.filter(f => f.path.includes('/mp3s/')),
                stems: files.filter(f => f.path.includes('/stems/')),
                images: files.filter(f => f.path.includes('/images/') || f.path.includes('/artwork/'))
            };

            const html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00FFFF; margin-bottom: 15px;">üìä File Type Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div style="background: rgba(0,255,255,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #00FFFF; margin-bottom: 8px;">üéµ Audio Files</h5>
                            <div style="font-size: 20px; font-weight: bold;">${fileTypes.audio.length}</div>
                            <div style="font-size: 11px; color: #888;">WAV & MP3 files</div>
                        </div>
                        <div style="background: rgba(0,255,0,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #4CAF50; margin-bottom: 8px;">üñºÔ∏è Images</h5>
                            <div style="font-size: 20px; font-weight: bold;">${fileTypes.image.length}</div>
                            <div style="font-size: 11px; color: #888;">Artwork & covers</div>
                        </div>
                        <div style="background: rgba(255,152,0,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #FF9800; margin-bottom: 8px;">üì¶ Stems</h5>
                            <div style="font-size: 20px; font-weight: bold;">${fileTypes.zip.length}</div>
                            <div style="font-size: 11px; color: #888;">ZIP packages</div>
                        </div>
                        <div style="background: rgba(128,128,128,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #888; margin-bottom: 8px;">üìÑ Total</h5>
                            <div style="font-size: 20px; font-weight: bold;">${files.length}</div>
                            <div style="font-size: 11px; color: #888;">All files</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00FFFF; margin-bottom: 15px;">üìÅ Catalog Structure</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(0,123,255,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #007bff; margin-bottom: 8px;">üìÖ 2022 Catalog</h5>
                            <div style="font-size: 18px; font-weight: bold;">${catalogFolders['2022'].length}</div>
                            <div style="font-size: 11px; color: #888;">files detected</div>
                        </div>
                        <div style="background: rgba(255,193,7,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #ffc107; margin-bottom: 8px;">üÜï 2025 Catalog</h5>
                            <div style="font-size: 18px; font-weight: bold;">${catalogFolders['2025'].length}</div>
                            <div style="font-size: 11px; color: #888;">files detected</div>
                        </div>
                        <div style="background: rgba(108,117,125,0.1); border-radius: 8px; padding: 15px;">
                            <h5 style="color: #6c757d; margin-bottom: 8px;">üìÇ Other Folders</h5>
                            <div style="font-size: 18px; font-weight: bold;">${catalogFolders['other'].length}</div>
                            <div style="font-size: 11px; color: #888;">files detected</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #00FFFF; margin-bottom: 15px;">üóÇÔ∏è Subfolder Organization</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="color: #00FFFF; font-size: 14px; font-weight: bold;">/wavs/</div>
                            <div style="font-size: 16px; margin: 5px 0;">${subfolders.wavs.length}</div>
                            <div style="font-size: 10px; color: #888;">WAV files</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="color: #4CAF50; font-size: 14px; font-weight: bold;">/mp3s/</div>
                            <div style="font-size: 16px; margin: 5px 0;">${subfolders.mp3s.length}</div>
                            <div style="font-size: 10px; color: #888;">MP3 files</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="color: #FF9800; font-size: 14px; font-weight: bold;">/stems/</div>
                            <div style="font-size: 16px; margin: 5px 0;">${subfolders.stems.length}</div>
                            <div style="font-size: 10px; color: #888;">ZIP stems</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 12px; text-align: center;">
                            <div style="color: #e91e63; font-size: 14px; font-weight: bold;">/images/</div>
                            <div style="font-size: 16px; margin: 5px 0;">${subfolders.images.length}</div>
                            <div style="font-size: 10px; color: #888;">Artwork</div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px; padding: 15px;">
                    <h5 style="color: #00FFFF; margin-bottom: 10px;">üîç Sample Files (showing first 15)</h5>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${files.slice(0, 15).map(file => `
                            <div style="padding: 6px; margin: 3px 0; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px;">
                                    ${getFileIcon(getFileTypeFromName(file.name))}
                                    <span style="color: #888;">${file.path.split('/').slice(0, -1).join('/')}/</span><span style="color: #fff;">${file.name}</span>
                                </span>
                                <span style="font-size: 10px; color: #888;">${formatFileSize(file.size)}</span>
                            </div>
                        `).join('')}
                        ${files.length > 15 ? `<div style="text-align: center; color: #888; padding: 10px; font-size: 12px;">... and ${files.length - 15} more files across all subfolders</div>` : ''}
                    </div>
                </div>
            `;

            listDiv.innerHTML = html;
        }

        async function importFromDropbox() {
            const url = document.getElementById('dropbox-url').value;
            if (!url) {
                logDropbox('Please enter a Dropbox folder URL', 'error');
                return;
            }

            if (!confirm('This will import all files from your Dropbox folder. Continue?')) {
                return;
            }

            logDropbox('üöÄ Starting Dropbox import...', 'info');

            // Show progress section
            document.getElementById('dropbox-progress').style.display = 'block';
            const progressBar = document.getElementById('dropbox-progress-bar');
            const statusText = document.getElementById('dropbox-status-text');

            try {
                statusText.textContent = 'Connecting to Dropbox...';
                progressBar.style.width = '10%';
                progressBar.textContent = '10%';

                const response = await supabase.functions.invoke('dropbox-catalog-processor', {
                    body: {
                        action: 'process_catalog',
                        folderUrl: url
                    }
                });

                if (response.error) {
                    throw new Error(response.error.message);
                }

                // Simulate progress updates
                const steps = [
                    { percent: 30, text: 'Analyzing files...' },
                    { percent: 50, text: 'Extracting metadata...' },
                    { percent: 70, text: 'Creating beat records...' },
                    { percent: 90, text: 'Organizing catalog...' },
                    { percent: 100, text: 'Import complete!' }
                ];

                for (const step of steps) {
                    progressBar.style.width = step.percent + '%';
                    progressBar.textContent = step.percent + '%';
                    statusText.textContent = step.text;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const result = response.data;
                displayDropboxResults(result);

                logDropbox('üéâ Import completed successfully!', 'success');
                logDropbox(`üìä Imported: ${result.beats?.length || 0} beats, ${result.audio_files?.length || 0} audio files, ${result.images?.length || 0} images`, 'success');

                // Refresh the tracks view if we're on that section
                if (window.currentSection === 'tracks') {
                    loadBeats();
                }

            } catch (error) {
                statusText.textContent = 'Import failed';
                logDropbox(`‚ùå Import failed: ${error.message}`, 'error');
            }
        }

        function displayDropboxResults(result) {
            document.getElementById('dropbox-results').style.display = 'block';

            const resultsHtml = `
                <div style="background: rgba(0,255,0,0.1); border: 1px solid #4CAF50; border-radius: 10px; padding: 20px;">
                    <h4 style="color: #4CAF50; margin-bottom: 15px;">üéâ Recursive Import Complete!</h4>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #00FFFF;">${result.beats?.length || 0}</div>
                            <div style="font-size: 12px; color: #ccc;">Beats Created</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">${result.bundles?.length || 0}</div>
                            <div style="font-size: 12px; color: #ccc;">Beat Bundles</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: #FF9800;">${result.processed || 0}</div>
                            <div style="font-size: 12px; color: #ccc;">Files Processed</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold; color: ${(result.errors || 0) > 0 ? '#f44336' : '#4CAF50'};">${result.errors || 0}</div>
                            <div style="font-size: 12px; color: #ccc;">Errors</div>
                        </div>
                    </div>

                    ${result.bundles && result.bundles.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <h5 style="color: #00FFFF; margin-bottom: 15px;">üì¶ Beat Bundle Summary</h5>
                            <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                                ${result.bundles.slice(0, 10).map(bundle => `
                                    <div style="padding: 8px; margin: 5px 0; background: rgba(0,255,255,0.1); border-radius: 6px; border-left: 3px solid #00FFFF;">
                                        <div style="font-weight: bold; color: #fff; margin-bottom: 5px;">${bundle.beatName}</div>
                                        <div style="font-size: 11px; color: #ccc;">
                                            <span style="color: ${bundle.files.wav === 'included' ? '#4CAF50' : '#888'};">WAV: ${bundle.files.wav}</span> ‚Ä¢
                                            <span style="color: ${bundle.files.mp3 === 'included' ? '#4CAF50' : '#888'};">MP3: ${bundle.files.mp3}</span> ‚Ä¢
                                            <span style="color: ${bundle.files.stems === 'included' ? '#4CAF50' : '#888'};">Stems: ${bundle.files.stems}</span> ‚Ä¢
                                            <span style="color: ${bundle.files.images !== '0 files' ? '#4CAF50' : '#888'};">Images: ${bundle.files.images}</span>
                                        </div>
                                    </div>
                                `).join('')}
                                ${result.bundles.length > 10 ? `
                                    <div style="text-align: center; padding: 10px; color: #888; font-size: 12px;">
                                        ... and ${result.bundles.length - 10} more beat bundles
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div style="background: rgba(0,255,255,0.1); border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h5 style="color: #00FFFF; margin-bottom: 10px;">‚ú® What Was Processed:</h5>
                        <ul style="color: #ccc; font-size: 13px; margin: 0; padding-left: 20px;">
                            <li>üóÇÔ∏è Scanned all subfolders: /2022 catalog/, /2025 catalog/, /wavs/, /mp3s/, /stems/, /images/</li>
                            <li>üéµ Grouped files by beat name into complete bundles</li>
                            <li>üì¶ Created beat records with WAV, MP3, stems, and artwork links</li>
                            <li>‚òÅÔ∏è All files remain in Dropbox - zero local storage used</li>
                            <li>üîó Direct download links created for each file type</li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="showSection('tracks')">
                            üéµ View Imported Beats
                        </button>
                        <button class="btn btn-secondary" onclick="location.reload()">
                            üîÑ Import Another Folder
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('analytics')">
                            üìä View Analytics
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('dropbox-results').innerHTML = resultsHtml;
        }

        function getFileIcon(type) {
            const icons = {
                'audio': 'üéµ',
                'image': 'üñºÔ∏è',
                'zip': 'üì¶',
                'pdf': 'üìÑ',
                'text': 'üìù',
                'other': 'üìÑ'
            };
            return icons[type] || 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>